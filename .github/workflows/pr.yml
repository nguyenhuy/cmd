name: Integration tests

on:
  pull_request:
    branches: [ "main" ]
concurrency:
  group: integration-tests-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}
jobs:
  build-release-app:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.1"
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    - name: Install node dependencies
      run: cd local-server && yarn install && yarn build && yarn copy-to-app
    # See https://github.com/actions/runner-images/issues/10722#issuecomment-2387952421
    - uses: extractions/netrc@v1
      with:
        machine: github.com
        username: oauth2
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Load derived data cache
      uses: actions/cache/restore@v4
      with:
        path: app/build/derived_data
        key: ${{ runner.os }}-app-derived-data-main
    - name: Build app in Release mode
      run: cd app && fastlane mac build_release
      env:
        FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: 60
        FASTLANE_XCODEBUILD_SETTINGS_RETRIES: 10
        MATCH_PASSWORD: ${{ secrets.FASTLANE_MACH_PASSWORD }}
        FASTLANE_MACH_REPO_GITHUB_ACCESS_TOKEN: ${{ secrets.FASTLANE_MACH_REPO_GITHUB_ACCESS_TOKEN }}

  test-swift:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.1"
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - name: Install dependencies
      run: cd local-server && yarn install && yarn build && yarn copy-to-app
    - name: Cache SPM .build
      uses: actions/cache@v4
      with:
        path: app/modules/.build
        key: ${{ runner.os }}-spm-app-modules-${{ hashFiles('app/modules/Package.swift') }}
        restore-keys: |
          ${{ runner.os }}-spm-app-modules-
    - name: Run tests
      run: cd app && ./cmd.sh test:swift

  lint-swift:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master
    - name: Install swiftformat
      run: brew install swiftformat
    - name: Run linter
      run: cd app && ./cmd.sh lint:swift
    - name: Verify that `cmd lint:swift` did not change outputs (if it did, please re-run it and re-commit!)
      run: git diff --exit-code

  sync-app-dependencies:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.1"
    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master
    - name: Install swiftformat
      run: brew install swiftformat
    - name: Cache dependencies binary
      uses: actions/cache@v4
      with:
        path: app/tools/dependencies/tmp/bin
        key: ${{ runner.os }}-spm-app-modules-${{ hashFiles('app/tools/dependencies/**') }}
        restore-keys: |
          ${{ runner.os }}-spm-app-modules-
    - name: Run sync dependencies
      run: cd app && ./cmd.sh sync:dependencies
    - name: Verify that `cmd sync:dependencies` did not change outputs (if it did, please re-run it and re-commit!)
      run: git diff --exit-code

  test-node:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - name: Install dependencies
      run: cd local-server && yarn install
    - name: Run tests
      run: cd local-server && yarn test

  tsc:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - name: Install dependencies
      run: cd local-server && yarn install
    - name: Run tests
      run: cd local-server && yarn tsc

  lint-node:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - name: Install dependencies
      run: cd local-server && yarn install
    - name: Run linter
      run: cd local-server && yarn lint:fix
    - name: Verify that `yarn lint:fix` did not change outputs (if it did, please re-run it and re-commit!)
      run: git diff --exit-code

  lint-shell:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - name: Set up Homebrew
      id: set-up-homebrew
      uses: Homebrew/actions/setup-homebrew@master
    - name: Install shfmt
      run: brew install shfmt
    - name: Run linter
      run: shfmt -w ./**/*.sh
    - name: Verify that `shfmt -w ./**/*.sh` did not change outputs (if it did, please re-run it and re-commit!)
      run: git diff --exit-code
