# This workflow will build a Swift project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-swift

name: Release MacOS app

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
concurrency:
  group: ${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/master' }}
jobs:
  build-release-app:
    runs-on: macos-15
    steps:
    - name: MacOS version
      run: sw_vers
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: "./local-server/.nvmrc"
    - uses: swift-actions/setup-swift@v2
      with:
        swift-version: "6.1"
    - uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    - name: Install node dependencies
      run: cd local-server && yarn install
    - uses: actions/checkout@v4
    - name: Make release
      run: cd app && fastlane distribute_release
      env:
        FASTLANE_MACH_REPO_GITHUB_ACCESS_TOKEN: ${{ secrets.FASTLANE_MACH_REPO_GITHUB_ACCESS_TOKEN }}
        MATCH_PASSWORD: ${{ secrets.FASTLANE_MACH_PASSWORD }}
        NOTARY_KEY_ID: ${{ secrets.NOTARY_KEY_ID }}
        NOTARY_P8: ${{ secrets.NOTARY_P8 }}
        NOTARY_ISSUER_ID: ${{ secrets.NOTARY_ISSUER_ID }}
        SPARKLE_SECRET_KEY: ${{ secrets.SPARKLE_SECRET_KEY }}
